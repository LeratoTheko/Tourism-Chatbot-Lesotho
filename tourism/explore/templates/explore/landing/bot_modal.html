<!-- Modernized Chatbot Modal -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<div class="modal fade" id="chatbotModal" tabindex="-1" aria-labelledby="chatbotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 500px;">
    <div class="modal-content border-0 shadow-lg" style="background: linear-gradient(145deg, #0a0a0a, #111); border-radius: 16px;">
      
      <!-- Header -->
      <div class="modal-header border-0 px-4 pt-4">
        <h5 class="modal-title fw-bold text-white" id="chatbotModalLabel">
          <i class="bi bi-robot me-2" style="color:#23bec8;"></i> Thato â€“ Tourism & Culture Chatbot
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Body -->
      <div class="modal-body px-4 pb-4">
        <!-- Chat area -->
        <div id="chat-area" class="rounded p-3 mb-3" 
             style="background:#0d0d0d; height:420px; overflow-y:auto; border:1px solid #1e1e1e; box-shadow: inset 0 0 10px rgba(35,190,200,0.2);">
          <div class="text-muted small">
            ðŸ‘‹ <strong>Hello!</strong> Iâ€™m <span style="color:#23bec8;">Thato</span>, your Tourism & Culture Assistant.<br>
            Ask me about <strong>Sesotho phrases</strong>, <strong>Basotho culture</strong>, or <strong>top attractions</strong> like Maletsunyane Falls and Thaba Bosiu!
          </div>
        </div>

        <!-- Input area -->
        <div class="d-flex align-items-center bg-dark rounded-pill px-3 py-2 shadow-sm" style="border:1px solid #1e1e1e;">
          <input id="chat-input" type="text" class="form-control border-0 bg-transparent text-white" placeholder="Type your message..." aria-label="Chat input">
          <button id="chat-send" class="btn rounded-circle ms-2" style="background-color:#23bec8; color:#fff; width:42px; height:42px;">
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Chat Script -->
<script>
  async function sendMessage(msg){
    const chatArea = document.getElementById('chat-area');

    // Display user message
    const userDiv = document.createElement('div');
    userDiv.className = 'text-end mb-2';
    userDiv.innerHTML = `<span class="badge bg-info text-dark p-2">${msg}</span>`;
    chatArea.appendChild(userDiv);
    chatArea.scrollTop = chatArea.scrollHeight;

    // Send to backend
    try {
      const res = await fetch("{% url 'chatbot_api' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: msg})
      });
      const data = await res.json();

      // Display bot reply
      const botDiv = document.createElement('div');
      botDiv.className = 'text-start mb-2';
      botDiv.innerHTML = `<span class="badge bg-light text-dark p-2">${data.reply}</span>`;
      chatArea.appendChild(botDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

    } catch (err) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'text-start text-danger small';
      errorDiv.textContent = "âš ï¸ Connection error. Please try again.";
      chatArea.appendChild(errorDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
  }

  // Send button click
  document.getElementById('chat-send').addEventListener('click', ()=>{
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if(!msg) return;
    input.value = '';
    sendMessage(msg);
  });

  // Press Enter to send
  document.getElementById('chat-input').addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') { e.preventDefault(); document.getElementById('chat-send').click(); }
  });
</script>
